version: "3.9"
services:
  genesis-generator:
    build: genesis-generator
    command:
      - all
    volumes:
      - ./data/genesis-generator:/data
      - ./genesis-config:/config
    ports:
      - 8000:8000
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000"]
      interval: 15s
      start_period: 10s
  
  geth-genesis:
    image: "ethereum/client-go:latest"
    command: --datadir=/execution init /genesis/custom_config_data/genesis.json
    volumes:
      - ./data/genesis-generator:/genesis
      - ./data/execution:/execution
    depends_on:
     genesis-generator:
        condition: service_healthy

  geth:
    image: "ethereum/client-go:latest"
    command:
      - --http
      - --http.api=eth,net,web3
      - --http.addr=0.0.0.0
      - --http.vhosts=*
      - --authrpc.vhosts=*
      - --authrpc.addr=0.0.0.0
      - --authrpc.jwtsecret=/genesis/el/jwtsecret
      - --datadir=/execution
      - --nat=extip:15.168.63.137
      - --networkid=133711
      - --nodiscover
      - --syncmode=full
    ports:
      - 8551:8551
      - 8545:8545
      - 30303:30303
    depends_on:
      geth-genesis:
        condition: service_completed_successfully
    volumes:
      - ./data/execution:/execution
      - ./data/genesis-generator:/genesis
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "8551"]
      interval: 15s
      start_period: 10s

  beacon-chain:
    image: "sigp/lighthouse:latest"
    command:
      - lighthouse
      - beacon_node
      - --http-address=0.0.0.0
      - --http-allow-sync-stalled
      - --execution-endpoint=http://geth:8551
      - --execution-jwt=/genesis/el/jwtsecret
      - --datadir=/consensus/beacon
      - --testnet-dir=/genesis/custom_config_data
      - --disable-packet-filter
      - --disable-peer-scoring
      - --staking
    depends_on:
      geth:
        condition: service_healthy
    ports:
      - 4000:4000
      - 3500:3500
      - 8080:8080
      - 5052:5052
    volumes:
      - ./data/consensus:/consensus
      - ./data/genesis-generator:/genesis

  validator-recover-wallet:
    image: "sigp/lighthouse:latest"
    command:
      - lighthouse
      - account_manager
      - validator
      - recover
      - --count=4
      - --datadir=/validator
      - --mnemonic-path=/genesis/custom_config_data/mnemonics.txt
    volumes:
      - ./data/validator:/validator
      - ./data/genesis-generator:/genesis
    depends_on:
      genesis-generator:
        condition: service_healthy

  validator:
    image: "sigp/lighthouse:latest"
    command:
      - lighthouse
      - validator
      - --init-slashing-protection
      - --datadir=/validator
      - --beacon-nodes=http://beacon-chain:5052
      - --testnet-dir=/genesis/custom_config_data
      - --suggested-fee-recipient=${FEE_RECIPIENT}
    depends_on:
      beacon-chain:
        condition: service_started
      validator-recover-wallet:
        condition: service_completed_successfully
    volumes:
      - ./data/consensus:/consensus
      - ./data/validator:/validator
      - ./data/genesis-generator:/genesis

  op-geth-genesis:
    image: "us-docker.pkg.dev/oplabs-tools-artifacts/images/op-geth:latest"
    command:
      - init
      - --datadir=/data
      - /config/genesis.json
    volumes:
      - ./data/op-geth:/data
      - ./l2-config:/config

  op-geth:
    image: "us-docker.pkg.dev/oplabs-tools-artifacts/images/op-geth:latest"
    command:
      - --datadir=/data
      - --http
      - --http.corsdomain=*
      - --http.vhosts=*
      - --http.addr=0.0.0.0
      - --http.api=web3,debug,eth,txpool,net,engine
      - --ws
      - --ws.addr=0.0.0.0
      - --ws.port=8546
      - --ws.origins=*
      - --ws.api=debug,eth,txpool,net,engine
      - --syncmode=full
      - --gcmode=archive
      - --nodiscover
      - --maxpeers=0
      - --networkid=42069
      - --authrpc.vhosts=*
      - --authrpc.addr=0.0.0.0
      - --authrpc.port=8551
      - --authrpc.jwtsecret=/config/jwt.txt
      - --rollup.disabletxpoolgossip=true
    volumes:
      - ./data/op-geth:/data
      - ./l2-config:/config
    ports:
      - 18545:8545
    depends_on:
      op-geth-genesis:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "8551"]
      interval: 15s
      start_period: 10s

  op-node:
    image: "us-docker.pkg.dev/oplabs-tools-artifacts/images/op-node:latest"
    command:
      - op-node
      - --l2=http://op-geth:8551
      - --l2.jwt-secret=/config/jwt.txt
      - --sequencer.enabled
      - --sequencer.l1-confs=3
      - --verifier.l1-confs=3
      - --rollup.config=/config/rollup.json
      - --rpc.addr=0.0.0.0
      - --rpc.port=8547
      - --p2p.disable
      - --rpc.enable-admin
      - --p2p.sequencer.key=${OP_SEQ_KEY}
      - --l1=http://geth:8545
      - --l1.rpckind=any
      - --log.level=debug
    volumes:
      - ./data/op-node:/data
      - ./l2-config:/config    
    depends_on:
      op-geth:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "8547"]
      interval: 15s
      start_period: 10s

  op-batcher:
    image: "us-docker.pkg.dev/oplabs-tools-artifacts/images/op-batcher:latest"
    command:
      - --l1-eth-rpc=http://geth:8545
      - --l2-eth-rpc=http://op-geth:8545
      - --rollup-rpc=http://op-node:8547
      - --poll-interval=1s
      - --sub-safety-margin=6
      - --num-confirmations=1
      - --safe-abort-nonce-too-low-count=3
      - --resubmission-timeout=30s
      - --rpc.addr=0.0.0.0
      - --rpc.port=8548
      - --rpc.enable-admin
      - --max-channel-duration=1
      - --private-key=${OP_BATCHER_KEY}
    depends_on:
      op-node:
        condition: service_healthy

  op-proposer:
    image: "us-docker.pkg.dev/oplabs-tools-artifacts/images/op-proposer:latest"
    command:
      - op-proposer
      - --poll-interval=12s
      - --rpc.port=8560
      - --rollup-rpc=http://op-node:8547
      - --l2oo-address=${OP_OO_ADDR}
      - --private-key=${OP_PROPOSER_KEY}
      - --l1-eth-rpc=http://geth:8545
    depends_on:
      op-node:
        condition: service_healthy
